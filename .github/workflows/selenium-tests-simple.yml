name: ğŸ§ª Selenium Tests - Simple

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  selenium-test:
    name: ğŸ” Run Selenium Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: quiz_pengupil
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ”§ Setup PHP & Apache
        run: |
          sudo apt-get update
          sudo apt-get install -y php apache2 libapache2-mod-php php-mysql php-curl
          sudo systemctl start apache2
      
      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      - name: âš™ï¸ Setup project in Apache
        run: |
          sudo mkdir -p /var/www/html/quiz-pengupil-main
          sudo cp -r . /var/www/html/quiz-pengupil-main
          sudo chown -R www-data:www-data /var/www/html/quiz-pengupil-main
          cat > /tmp/apache-config.conf << 'EOF'
          <VirtualHost *:80>
              ServerName localhost
              DocumentRoot /var/www/html
              <Directory /var/www/html>
                  AllowOverride All
                  Require all granted
              </Directory>
          </VirtualHost>
          EOF
          sudo tee /etc/apache2/sites-available/000-default.conf > /dev/null < /tmp/apache-config.conf
          sudo systemctl restart apache2
      
      - name: â³ Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h localhost -u root -proot && break || sleep 1
          done
      
      - name: ğŸ“Š Import database
        run: |
          mysql -h localhost -u root -proot quiz_pengupil < db/quiz_pengupil.sql
      
      - name: âœ… Verify database
        run: |
          mysql -h localhost -u root -proot quiz_pengupil -e "SHOW TABLES;"
      
      - name: ğŸ¥ Wait for Apache
        run: |
          for i in {1..30}; do
            curl -f http://localhost/quiz-pengupil-main/login.php > /dev/null 2>&1 && break || sleep 2
          done
      
      - name: ğŸŒ Health check
        run: |
          curl -i http://localhost/quiz-pengupil-main/login.php | head -n 5
      
      - name: ğŸ§ª Run Selenium tests
        run: |
          python -m pytest test_selenium_login_register.py -v --html=report.html --self-contained-html --junit-xml=junit.xml || true
        env:
          BASE_URL: http://localhost/quiz-pengupil-main
      
      - name: ğŸ“Š Display test results
        if: always()
        run: |
          echo "=== ğŸ§ª SELENIUM TEST RESULTS ===" 
          if [ -f junit.xml ]; then
            python -c "
import xml.etree.ElementTree as ET
try:
  tree = ET.parse('junit.xml')
  root = tree.getroot()
  testcases = root.findall('.//testcase')
  errors = root.findall('.//error')
  failures = root.findall('.//failure')
  
  total = len(testcases)
  passed = total - len(errors) - len(failures)
  failed = len(failures)
  error_count = len(errors)
  
  print(f'ğŸ“ˆ Test Metrics:')
  print(f'  â€¢ Total Tests: {total}')
  print(f'  â€¢ Passed: {passed} âœ…')
  print(f'  â€¢ Failed: {failed} âŒ')
  print(f'  â€¢ Errors: {error_count} âš ï¸')
  print()
  
  if failed == 0 and error_count == 0:
    print(f'âœ… ALL {total} TESTS PASSED!')
  else:
    print(f'âš ï¸ {failed + error_count} tests need attention')
except Exception as e:
  print(f'Error parsing results: {e}')
            "
          fi
      
      - name: ğŸ“¤ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            junit.xml
            report.html
          retention-days: 30
      
      - name: âœ… Done
        run: |
          echo "ğŸ Tests completed!"
