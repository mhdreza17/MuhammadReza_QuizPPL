name: ğŸ§ª Login & Register Module - Selenium Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Jalankan test setiap hari pukul 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: ğŸ” Selenium Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: quiz_pengupil
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306
      
      apache:
        image: php:8.1-apache
        options: >-
          --mount type=bind,source=${{ github.workspace }},target=/var/www/html
          --publish 80:80
        env:
          PHP_INI_SCAN_DIR: /etc/php/conf.d
    
    steps:
    # ============================================
    # STEP 1: CHECKOUT CODE
    # ============================================
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    # ============================================
    # STEP 2: SETUP ENVIRONMENT
    # ============================================
    - name: ğŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mysqli, pdo, pdo_mysql, curl
        ini-values: display_errors=On
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # ============================================
    # STEP 3: INSTALL DEPENDENCIES
    # ============================================
    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium pytest python-dotenv webdriver-manager
        echo "âœ… Python dependencies installed"
    
    - name: ğŸ”Œ Setup Apache
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y apache2 curl
        sudo a2enmod rewrite
        sudo systemctl start apache2
        echo "âœ… Apache setup complete"
    
    # ============================================
    # STEP 4: COPY PROJECT FILES
    # ============================================
    - name: ğŸ“‚ Copy project to Apache root
      run: |
        sudo cp -r ${{ github.workspace }}/* /var/www/html/
        sudo chown -R www-data:www-data /var/www/html
        echo "âœ… Project files copied"
    
    # ============================================
    # STEP 5: DATABASE SETUP
    # ============================================
    - name: â³ Wait for MySQL
      run: |
        for i in {1..60}; do
          if mysql -h 127.0.0.1 -u root -proot -e "SELECT 1" >/dev/null 2>&1; then
            echo "âœ… MySQL is ready"
            break
          fi
          echo "â³ Waiting for MySQL... ($i/60)"
          sleep 1
        done
    
    - name: ğŸ“Š Import database schema
      run: |
        mysql -h 127.0.0.1 -u root -proot quiz_pengupil < ${{ github.workspace }}/db/quiz_pengupil.sql
        echo "âœ… Database schema imported"
    
    - name: ğŸ” Verify database
      run: |
        mysql -h 127.0.0.1 -u root -proot quiz_pengupil -e "SHOW TABLES;"
        echo "âœ… Database verified"
    
    # ============================================
    # STEP 6: APPLICATION READY CHECK
    # ============================================
    - name: â³ Wait for Apache
      run: |
        for i in {1..60}; do
          if curl -s http://localhost/quiz-pengupil-main/login.php > /dev/null 2>&1; then
            echo "âœ… Apache is ready"
            break
          fi
          echo "â³ Waiting for Apache... ($i/60)"
          sleep 1
        done
    
    - name: âœ… Health check
      run: |
        curl -s http://localhost/quiz-pengupil-main/login.php | grep -q "Sign-In" && echo "âœ… Application is healthy" || exit 1
    
    # ============================================
    # STEP 7: CONFIGURATION
    # ============================================
    - name: ğŸ” Create environment file
      run: |
        echo "BASE_URL=http://localhost/quiz-pengupil-main" > ${{ github.workspace }}/.env
        echo "TEST_TIMEOUT=10" >> ${{ github.workspace }}/.env
        echo "âœ… Environment file created"
    
    # ============================================
    # STEP 8: RUN SELENIUM TESTS
    # ============================================
    - name: ğŸ§ª Run Selenium Tests
      id: test
      run: |
        cd ${{ github.workspace }}
        pytest test_selenium_login_register.py -v --tb=short --junit-xml=junit.xml --html=report.html --self-contained-html
        echo "test_status=passed" >> $GITHUB_OUTPUT
      env:
        BASE_URL: http://localhost/quiz-pengupil-main
      continue-on-error: true
    
    # ============================================
    # STEP 9: TEST RESULTS ANALYSIS
    # ============================================
    - name: ğŸ“Š Parse test results
      if: always()
      run: |
        echo "=== TEST EXECUTION SUMMARY ===" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f junit.xml ]; then
          TESTS=$(grep -o 'tests="[0-9]*"' junit.xml | grep -o '[0-9]*')
          FAILURES=$(grep -o 'failures="[0-9]*"' junit.xml | grep -o '[0-9]*')
          ERRORS=$(grep -o 'errors="[0-9]*"' junit.xml | grep -o '[0-9]*')
          
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| Failures | $FAILURES |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All Tests PASSED!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Some Tests FAILED!**" >> $GITHUB_STEP_SUMMARY
          fi
        fi
    
    # ============================================
    # STEP 10: UPLOAD ARTIFACTS
    # ============================================
    - name: ğŸ“¤ Upload test results (v4)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os || 'linux' }}-${{ github.run_number }}
        path: |
          junit.xml
          report.html
        retention-days: 30
        if-no-files-found: ignore
    
    - name: ğŸ“ˆ Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ github.run_number }}
        path: htmlcov/
        retention-days: 7
        if-no-files-found: ignore
    
    # ============================================
    # STEP 11: PUBLISH TEST REPORT
    # ============================================
    - name: ğŸ“‹ Publish test report
      if: always() && hashFiles('junit.xml') != ''
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: junit.xml
        check_name: ğŸ§ª Selenium Test Results
        comment_title: Test Results Summary
    
    # ============================================
    # STEP 12: GITHUB STATUS CHECK
    # ============================================
    - name: âŒ Fail if tests failed
      if: failure()
      run: |
        echo "âŒ Selenium tests failed!"
        exit 1
    
    # ============================================
    # STEP 13: SUCCESS NOTIFICATION
    # ============================================
    - name: âœ… Tests completed successfully
      if: success()
      run: |
        echo "âœ… All 21 test cases PASSED!"
        echo "ğŸ“Š Report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
